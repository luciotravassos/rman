PROCEDIMENTO CLONE HML_BOB PARA HS_BOB

1. Em $ORACLE_HOME/scripts

Alterar o script de backup de archive

 ARCHIVELOG ALL;
##    ARCHIVELOG ALL DELETE INPUT; 

2. CAMADA DE REDE

A) TNSNAMES.ORA

# tnsnames.ora Network Configuration File: /u04/app/oracle/product/12.1.0/db_4/network/admin/tnsnames.ora
# Generated by Oracle configuration tools.

LISTENER_BDTHSBOB =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 10.64.113.16)(PORT = 1521))


BDTHSBOB =
  (DESCRIPTION=
    (ADDRESS=(PROTOCOL=TCP)(HOST=10.64.113.16)(PORT=1521))
    (CONNECT_DATA=
      (SERVER=DEDICATED)
      (SERVICE_NAME=BDTHSBOB)
    )
  )

RMAN = (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.100.208)(PORT = 1530)) (CONNECT_DATA = (SERVICE_NAME = RMANCAT)))

BDTHSBOB_1 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = BOBdbhm1)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = BDTHSBOB_1)
        (UR=A)
)
  )

BDTHBOB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = BOBdbhm2)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = BDTHBOB)
        (UR=A)))

		
B) Listener.ora (não alteramos)

3) Verificar o tamanho das instâncias 

Origem para destino rodar o script abaixo considerando o tamanho do alocado


select sum(round(a.BYTES / 1024 / 1024 / 1024) )"GB Allocated",
       sum(round((a.BYTES-nvl(b.BYTES, 0)) / 1024 / 1024 / 1024) )"GB Used"
from   (select   TABLESPACE_NAME,
                 sum(BYTES) BYTES
        from     sys.dba_data_files
        group by TABLESPACE_NAME) a,
       (select   TABLESPACE_NAME,
                 sum(BYTES) BYTES
        from     sys.dba_free_space
        group by TABLESPACE_NAME) b
where  a.TABLESPACE_NAME = b.TABLESPACE_NAME (+);


E/OU

/* Script para analisar o tamanho do datafil*/
SELECT SUBSTR (TO_CHAR (SUM (BYTES) / 1024 / 1024, '999,999,999.99'),
               1,
               15
              ) "Total MB",
       SUBSTR (TO_CHAR (SUM (BYTES) / 1024 / 1024 / 1024, '999,999.99'),
               1,
               11
              ) "Total GB"
  FROM SYS.dba_data_files;
  
4) Validar

A) db_file_name_convert = +DG_BDTHBOB_DATA01, +DG_BDTHMLSBOB_DATA01, +DG_MIGRACAO_DATA01, +DG_BDTHMLSBOB_DATA01, +DG_BDOHBOB_DATA01, +DG_BDTHMLSBOB_DATA01
B) log_file_name_convert = +DG_BDTHBOB_DATA01, +DG_BDTHMLSBOB_DATA01
C) connect auxiliary sys/Cocada123@BDTHSBOB ;
D) connect target sys/Cocada123@BDTHBOB;  
  

5) Baixar a instância destino no caso do procedimento é HS
6) Entrar no ASM e remover os datafiles, controlfiles deixando apenas o parameter file; rodar o sql abaixo para garantir que tem 99.9% de espaço livre

select name Diskgroup,round(total_mb/1024,2) "Total_TB",round(free_mb/1024,2) "Free_GB",round(((free_mb/total_mb)*100),2) "Available%" from v$asm_diskgroup;

7) Colocar a instância alvo em modo NOMOUNT

8) Executar o script abaixo em modo background (nohup rman "@rman_duplicate.sql" > rman_duplicate_9.out &)

cat rman_duplicate.sql
connect auxiliary sys/Cocada123@BDTHSBOB ;
connect target sys/Cocada123@BDTHBOB;
connect catalog visarman/visarman@rman;
RUN {
DUPLICATE TARGET DATABASE TO BDTHSBOB from active database NOFILENAMECHECK;
}

9) Em $ORACLE_HOME/scripts

Remover o comentário do script de backup de archive

10) Validar o ambiente

Obs: Pode haver erro de listener, talvez seja necessário um SID_LISTENER

